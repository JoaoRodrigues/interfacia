!
! Calculates pairwise residue-residue energies at the interface.
! Adapted from HADDOCK protocols here and there.
! JR @ 2015
!

evaluate ($coorin = "molecule_cmplt.pdb")
evaluate ($interface_dist_cutoff = 5.0)

! Mute (most) output
set message=off echo=off end

!
! Read parameter and topology databases
!

parameter
    @@toppar/protein-allhdg5-4.param
    @@toppar/ion.param
    @@toppar/ligand.param
end

topology
    @@toppar/protein-allhdg5-4.top
    @@toppar/protein_break.top
    @@toppar/ion.top
    @@toppar/ligand.top
end

!
! Read coordinates
!

segment
  chain
    @@toppar/protein-allhdg5-4.link
    separate=true
    coordinates @@$coorin
  end
end

coordinates @@$coorin

delete sele=(hydrogen and attr charge = 0) end
delete sele=(not known) end

flags
    exclude *
    include vdw elec
end

!
! Get interfacial residues of chain A (receptor)
! Assume chains A & B
!
do (store1 = 1) (byres (segid A and
                        (not segid A) around $interface_dist_cutoff))

evaluate ($buffer_file = $coorin - ".pdb" + ".pwr_ene")
buffer energies to=file=$buffer_file end
buffer energies
    display ## Pairwise Interface Residue-Residue Energies ($coorin)
end

for $id_a in id (attr store1 = 1 and tag) loop res_a
    show (resid) (id $id_a)
    evaluate ($resi_a = $result)
    show (resn) (id $id_a)
    evaluate ($resn_a = $result)

    do (store2 = 0) (segid B)
    for $id_b in id ( segid B and (segid A and resid $resi_a) around $interface_dist_cutoff ) loop res_b
        show (resid) (id $id_b)
        evaluate ($resi_b = $result)
        show (resn) (id $id_b)
        evaluate ($resn_b = $result)

        ! Avoid multiple calcs per residue
        identity (store3) (segid B and resid $resi_b and attribute store2 > 0)
        if ( $select = 0 ) then
            igroup interaction (segid A and resid $resi_a) (segid B and resid $resi_b) end
            energy end
            ! Calculate total energy as per HADDOCK scoring function
            evaluate ($total = ($vdw + $elec))
            buffer energies
                display # A $resi_a $resn_a <> B $resi_b $resn_b - vdW = $vdw elec = $elec total = $total
            end
            do (store2 = 1) (segid B and resid $resi_b)
        end if
    end loop res_b

end loop res_a

buffer energies dump end

stop
